name: CI

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Test & Build
    timeout-minutes: 60
    runs-on: ubuntu-latest

    # PostgreSQLをサービスコンテナとして起動 (Playwrightの設定に合わせる)
    services:
      postgres:
        image: postgres:17.4
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        # ホストの5433をコンテナの5432に繋ぐ (playwright.config.tsの設定と一致させる)
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # 1. 単体テストの実行 (Unit Tests)
      - name: Run Unit Tests
        run: npm test

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # 2. データベースのセットアップ (Migrate & Seed)
      - name: Setup Database
        env:
          # ポート5433を指定 (servicesでマッピングしたポート)
          DATABASE_URL: "postgresql://testuser:testpass@localhost:5433/testdb"
          SEED_ENV: "test"
        run: |
          npx prisma migrate deploy
          npx prisma db seed

      # 3. ビルド確認
      - name: Build Next.js App
        env:
          DATABASE_URL: "postgresql://testuser:testpass@localhost:5433/testdb"
          AUTH_SECRET: "dummy_secret_for_ci_build"
          GOOGLE_CLIENT_ID: "dummy_client_id"
          GOOGLE_CLIENT_SECRET: "dummy_client_secret"
          DISCORD_CLIENT_ID: "dummy_discord_id"
          DISCORD_CLIENT_SECRET: "dummy_discord_secret"
        run: npm run build

      # 4. E2Eテストの実行
      - name: Run Playwright tests
        env:
          # テスト実行用環境変数
          DATABASE_URL: "postgresql://testuser:testpass@localhost:5433/testdb"
          AUTH_SECRET: "dummy_secret_for_ci_test"
          GOOGLE_CLIENT_ID: "dummy_client_id"
          GOOGLE_CLIENT_SECRET: "dummy_client_secret"
          DISCORD_CLIENT_ID: "dummy_discord_id"
          DISCORD_CLIENT_SECRET: "dummy_discord_secret"
          NEXT_PUBLIC_BASE_URL: "http://localhost:3000"
          CI: true
        run: npx playwright test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30