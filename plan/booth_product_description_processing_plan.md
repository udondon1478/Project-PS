# Booth 商品説明処理計画

## プロジェクト概要

PolySeek は、VRChat 向け Booth.pm 商品をタグベースで検索できる Web アプリケーションです。Booru 系サイトの検索システムを参考に、ユーザーがアバターやアセットを効率的に探せるモダンな UI を目指しています。

## 今回のタスクの目的

Booth.pm の商品登録・更新機能において、商品説明文を正確に抽出し、指定された HTML 構造（特に `section.main-info-column` および `my-40` クラスを持つ要素内の `.shop__text`）を解析して Markdown 形式に変換し、データベースに保存できるようにすること。特に、`my-40` 内に構造化された商品説明や改行が含まれる場合の問題を解決することを目的としました。

## 問題の原因推測

`my-40` クラスを持つ要素に商品説明が含まれる場合に商品登録が失敗する問題は、主に以下の点が原因であると推測されました。

1.  **複雑な HTML 構造の解析不足:** `my-40` 内に複数の `<section class="shop__text">` 要素がネストされており、その中に見出しタグ (`<h2>` など) や段落タグ (`<p>`) が含まれる構造を、既存の処理が適切に扱えていなかった。
2.  **改行処理の不備:** HTML の `<p>` タグ内の改行（テキストノード内の改行や `<br>` タグ）が、Markdown 変換時に正しく反映されず、テキストが連結されてしまっていた。

## 問題解決のための処理フロー

問題解決のために、以下の処理フローで実装を進めました。

1.  **Booth URL 入力:** ユーザーが Booth の商品 URL を入力します。
2.  **データベース登録確認:** 入力された URL の商品がすでにデータベースに登録されているか確認します。
3.  **更新確認 (登録済みの場合):** 登録済みの場合は、説明文などに更新があるかユーザーに確認します。（この部分は今回のタスクの対象外）
4.  **HTML 取得:** Booth の商品ページから HTML コンテンツを取得します (fetch MCP を使用)。
5.  **HTML 解析:** 取得した HTML を cheerio を使用して解析します。
6.  **商品説明要素特定:** `section.main-info-column` および `.my-40` クラスを持つ要素を特定します。
7.  **商品説明の抽出と構造化:**
    *   `.main-info-column` 内の `.js-market-item-detail-description.description p` のテキストを抽出します。
    *   `.my-40` 要素が存在する場合、その中の各 `.shop__text` セクションを走査し、見出し (`h1`〜`h6`) と段落 (`p`) を抽出します。
8.  **Markdown への変換:**
    *   抽出したテキストや見出しを Markdown 形式に変換します。特に、`<p>` タグ内のテキストと `<br>` タグを適切に処理し、Markdown の改行に変換します。見出しタグは Markdown の見出し記法（`## ` など）に変換します。
    *   変換した各部分を結合し、最終的な商品説明 Markdown を作成します。
9.  **データベース保存/更新:** 作成した商品説明 Markdown を含む商品情報をデータベースに保存または更新します。

```mermaid
graph TD
    A[Booth URL入力] --> B{データベースに登録済みか?};
    B -- はい --> C{更新が必要か?};
    C -- はい --> D[BoothからHTML取得];
    C -- いいえ --> E[最新情報を表示];
    B -- いいえ --> D;
    D --> F[HTML解析 (cheerio)];
    F --> G[商品説明要素特定 (.main-info-column, .my-40)];
    G --> H{my-40要素にコンテンツあり?};
    H -- はい --> I[my-40内のshop__text抽出];
    H -- いいえ --> J[main-info-column内のpタグ抽出];
    I --> K[shop__textをMarkdown変換 (見出し, 段落, 改行処理)];
    J --> L[pタグをMarkdown変換 (改行処理)];
    K --> M[変換結果を結合];
    L --> M;
    M --> N[データベース保存/更新];
    N --> O[完了];
    E --> O;
```

## 実施した修正内容

`src/app/api/items/route.ts` ファイルに対して、以下の修正を実施しました。

*   `cheerio` を使用して `.main-info-column` および `.my-40` 要素をより堅牢なセレクタで取得するように変更しました。
*   `.my-40` 要素内の `.shop__text` クラスを持つ各 `<section>` 要素を繰り返し処理し、その中の見出し (`h1`〜`h6`) と段落 (`p`) を抽出するロジックを実装しました。
*   特に、`<p>` タグ内のコンテンツを走査し、テキストノードと `<br>` タグを区別して処理することで、HTML の改行を Markdown の改行に正しく変換できるように修正しました。
*   抽出した見出しは Markdown の見出し記法に、段落は Markdown の段落として整形し、結合して最終的な商品説明 Markdown を生成するようにしました。
*   連続する改行を適切に処理するための整形処理を追加しました。

これらの修正により、`my-40` 内に構造化された商品説明や改行が含まれる場合でも、意図した通りに商品説明を抽出・変換し、データベースに保存することが可能になりました。

## 今後のステップ

今回のタスクで商品説明の抽出・変換に関する問題は解決しましたが、ユーザーが最初に述べた仕様には以下の要素が含まれており、これらは今後のタスクとして検討が必要です。

*   データベースに商品が登録済みの場合の、説明文などの更新確認フローの実装。
*   データベースに商品が登録されていない場合、タグ以外のフォームを URL から取得した情報で自動補完し、ユーザーが編集できないようにする機能の実装。
*   ユーザーが商品に対してタグを付けられる機能の実装。

これらの機能は、PolySeek の商品登録・更新機能全体を完成させるために重要です。