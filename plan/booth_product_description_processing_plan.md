# Booth.pm 商品情報処理フロー改修計画

## プロジェクト概要
VRChat向けBooth.pm商品をタグベースで検索できるWebアプリケーション「PolySeek」の商品登録機能に関する改修計画。Booth.pmへの負荷軽減と、新規登録時のタグ手動入力を目的とする。

## 目標
1.  Booth.pmへの負荷軽減のため、データベースに商品が登録済みの場合、既存DB情報（タイトル、説明、価格など）を表示し、ユーザーの更新承認後にBooth.pmから最新情報を取得して更新するフローを実装する。
2.  データベースに商品が登録されていない場合、タグ以外の情報はURLから取得した情報を登録ページに表示し、タグはユーザーが手動で入力して新規登録するフローを実装する。

## 計画詳細

1.  **APIエンドポイント (`src/app/api/items/route.ts`) の改修:**
    *   受け取ったBooth.pmのURLに対応する商品がデータベースに存在するかを確認する。
    *   **商品が存在する場合:**
        *   Booth.pmへのスクレイピングは行わない。
        *   データベースから既存の商品情報（タイトル、説明、価格、画像URL、販売者情報など）を取得し、フロントエンドに返す。レスポンスには、これが既存の商品情報であり、更新確認が必要であることを示すフラグ（例: `status: 'existing'`）を含める。
    *   **商品が存在しない場合:**
        *   Booth.pmからタグ以外の情報（タイトル、説明、価格、画像URL、販売者情報など）をスクレイピングする。
        *   取得した情報をデータベースに保存せず、フロントエンドに返す。レスポンスには、これが新規登録のための情報であり、タグの手動入力が必要であることを示すフラグ（例: `status: 'new'`）を含める。
        *   タグ情報はBooth.pmからは取得しない。

2.  **商品登録ページ (`src/app/register-item/page.tsx`) の改修:**
    *   `/api/items` からのレスポンスを処理するロジックを追加する。
    *   レスポンスのステータスフラグ（`status: 'existing'` または `status: 'new'`）に応じて、表示するUIを切り替える。
    *   **`status: 'existing'` の場合（更新確認フロー）:**
        *   取得した既存の商品情報（タイトル、説明、価格、画像など）を表示するUIを実装する。
        *   ユーザーが更新を承認するためのボタンを配置する。
        *   更新承認ボタンがクリックされたら、データベースを更新するための新しいAPIエンドポイント（例: `/api/items/update`）を呼び出す。このAPIは、Booth.pmから最新の情報をスクレイピングしてデータベースを更新する役割を持つ。
    *   **`status: 'new'` の場合（新規登録フロー）:**
        *   Booth.pmから取得したタグ以外の情報（タイトル、説明、画像など）を表示するUIを実装する。
        *   タグを入力するためのフォームを実装する。
        *   登録ボタンを配置する。
        *   登録ボタンがクリックされたら、新規登録のための新しいAPIエンドポイント（例: `/api/items/create`）を呼び出す。この際、ユーザーが入力したタグ情報も一緒に送信する。

3.  **新規登録用APIエンドポイント (例: `src/app/api/items/create/route.ts`) の作成:**
    *   フロントエンドから送られてきた商品情報（タグ以外のBooth.pmから取得した情報 + ユーザーが手動入力したタグ）を受け取る。
    *   受け取った情報を使って、データベースに新しい商品を登録する。`Product` モデルと `ProductTag` モデルにデータを保存する。

4.  **更新用APIエンドポイント (例: `src/app/api/items/update/route.ts`) の作成:**
    *   フロントエンドから送られてきた商品IDを受け取る。
    *   受け取った商品IDに対応するBooth.pmのURLを使って、Booth.pmから最新の商品情報（タイトル、説明、価格、画像など）をスクレイピングする。
    *   スクレイピングした情報を使って、データベースの既存の商品情報を更新する。

## フロー図

```mermaid
graph TD
    A[ユーザーがURLを入力] --> B{データベースに商品が存在するか？};
    B -- はい --> C[既存商品情報を取得];
    C --> D[フロントエンドに既存商品情報とstatus:'existing'を返す];
    D --> E[フロントエンドで既存商品情報と更新承認ボタンを表示];
    E -- 更新承認 --> F[更新用APIを呼び出す];
    F --> G[Booth.pmから最新情報をスクレイピング];
    G --> H[データベースを更新];
    H --> I[完了メッセージを表示];

    B -- いいえ --> J[Booth.pmからタグ以外の情報をスクレイピング];
    J --> K[フロントエンドにスクレイピング結果とstatus:'new'を返す];
    K --> L[フロントエンドでスクレイピング結果とタグ入力フォームを表示];
    L -- タグ入力&登録 --> M[新規登録用APIを呼び出す];
    M --> N[データベースに新規登録];
    N --> I;

    I --> O[完了];