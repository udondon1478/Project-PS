# データベースセッション実装計画

## 概要
PolySeekプロジェクトにおいて、Auth.jsのセッション管理方法をJWTセッションからデータベースセッションに切り替え、商品登録時にログインユーザーのIDをデータベースに記録できるようにする。

## 計画ステップ

### ステップ 0: `@auth/prisma-adapter` パッケージのインストール
- `@auth/prisma-adapter` パッケージがプロジェクトにインストールされているか確認する。
- インストールされていない場合は、npmを使用してインストールする。

### ステップ 1: Prisma Adapterの組み込み
- `src/auth.ts` を開き、`@auth/prisma-adapter` から `PrismaAdapter` をインポートする。
- PrismaClientのインスタンスがシングルトンとして適切に作成され、エクスポートされているファイル（例: `lib/prisma.ts`）があるか確認する。ない場合は作成し、シングルトンインスタンスをエクスポートするようにする。
- `src/auth.ts` で、作成または確認したPrismaClientのシングルトンインスタンスをインポートする。
- `src/auth.ts` の `NextAuth` 設定オブジェクトに `adapter: PrismaAdapter(prisma)` を追加する。
- `prisma/schema.prisma` にAuth.jsが必要とするモデル (`Account`, `Session`, `User`, `VerificationToken`) が定義されていることを再確認する。

### ステップ 2: データベースセッションへの切り替え確認
- アプリケーションを起動する。
- ユーザーのログイン・ログアウトを試す。
- データベースの `sessions` テーブルにセッション情報が保存されることを確認する。

### ステップ 3: 商品登録とユーザーIDの紐づけ
- 商品登録を行うAPIルート（例: `src/app/api/items/route.ts`）を修正する。
- APIルート内で、`getServerSession()` または `auth()` を使用してセッション情報を取得する。
- 取得したセッション情報から `session.user.id` （データベース上のユーザーID）を取得する。
- 商品データをデータベースに保存する際に、商品のテーブルにユーザーIDを保存するためのカラム（例: `registeredById`）が存在することを確認する。存在しない場合はPrismaスキーマにカラムを追加し、マイグレーションを実行する。
- 商品データをデータベースに保存する処理において、取得した `session.user.id` を商品のレコードの該当カラムに設定する。

## 計画の視覚化

```mermaid
graph TD
    A[ユーザーログイン] --> B{認証成功};
    B --> C[Auth.jsがセッション作成];
    C --> D[セッション情報をDBに保存];
    C --> E[セッションIDをCookieに保存];
    E --> F[ユーザー操作 (商品登録)];
    F --> G[サーバーサイドAPI呼び出し];
    G --> H[Auth.jsがCookieからセッションID取得];
    H --> I[DBからセッション情報取得];
    I --> J[セッション情報からユーザーID取得];
    J --> K[商品データとユーザーIDをDBに保存];
    K --> L[商品登録完了];
```

## 今後のステップ
この計画に基づき、Codeモードで実装を進める。