# タグ候補サジェスト機能 実装計画

## プロジェクト概要
PolySeekは、VRChat向けBooth.pm商品をタグベースで検索できるWebアプリケーションです。Booru系サイトの検索システムを参考に、ユーザーがアバターやアセットを効率的に探せるモダンなUIを提供します。

## 機能概要
本計画では、既存の検索機能に対して、ユーザーが検索バーにタグを入力する際に、データベースに登録されているタグの中から関連性の高い候補をサジェストとして表示し、選択または入力確定によってタグを検索クエリとして追加できる機能を追加します。

## 目標

1.  ユーザーが検索バーに文字を入力するたびに、入力された文字列を含むタグをデータベースから取得し、登録数が多い順にサジェストとして表示する。
2.  ユーザーが半角スペースを入力するか、サジェストリストからタグを選択した場合に、そのタグを確定させ、検索バーの下部に錠剤状の表示で追加する。
3.  錠剤状のタグをクリックすることで削除できるようにする。
4.  検索実行時に、選択されたタグをクエリパラメータとして検索結果ページに渡す。

## 計画詳細

1.  **[`src/components/search/ProductSearch.tsx`](src/components/search/ProductSearch.tsx) の修正:**
    *   現在のクライアントサイドでのタグフィルタリングロジックを削除し、入力値 (`searchQuery`) をクエリパラメータとして [`/api/tags/search`](src/app/api/tags/search/route.ts) エンドポイントにフェッチリクエストを送信する処理に置き換えます。
    *   APIからの応答として受け取ったタグリストを `tagSuggestions` ステートにセットします。
    *   API呼び出しは、ユーザーの入力頻度を考慮してデバウンス処理を導入し、不要なAPIリクエストを減らします。
    *   ユーザーが半角スペースを入力した際に、現在の `searchQuery` をタグとして確定し、`selectedTags` リストに追加するロジックを追加します。その後、`searchQuery` をクリアします。
    *   サジェストリストからタグが選択された場合も、そのタグを `selectedTags` リストに追加し、`searchQuery` をクリアする既存のロジックを維持します。
    *   錠剤状のタグ表示と削除機能は既存のものを利用します。
    *   検索実行 (`handleSearch`) 時には、`selectedTags` の内容をクエリパラメータとして `/search` ページに渡す既存のロジックを維持します。

2.  **APIエンドポイント [`src/app/api/tags/search/route.ts`](src/app/api/tags/search/route.ts) の利用:**
    *   このエンドポイントは既に登録数順のソートと件数制限（10件）を実装しているため、このまま利用します。

3.  **データベーススキーマ [`prisma/schema.prisma`](prisma/schema.prisma) の利用:**
    *   `Tag` モデルの `count` フィールドはタグの登録数として適切であり、APIで利用されているため、スキーマの変更は不要です。

## フロー図

```mermaid
graph TD
    A[ユーザーが検索バーに文字を入力] --> B{入力値の変更を検知};
    B --> C{入力値が空でないか？};
    C -- Yes --> D[Debounce処理];
    D --> E[APIエンドポイント /api/tags/search を呼び出し];
    E --> F{API応答を受信};
    F --> G[タグ候補リストを更新];
    G --> H[サジェストリストを表示];
    C -- No --> I[サジェストリストを非表示];
    A --> J{ユーザーが半角スペースを入力};
    J --> K[現在の入力値をタグとして確定];
    K --> L[確定したタグを錠剤状に追加];
    L --> M[入力値をクリア];
    H --> N{ユーザーがサジェストを選択};
    N --> K;
    A --> O{ユーザーがEnterキーを押下};
    O --> P{サジェストが表示されているか？};
    P -- Yes --> Q{候補リストに要素があるか？};
    Q -- Yes --> R[最上位の候補をタグとして追加];
    R --> L;
    Q -- No --> S{入力値があるか？};
    S -- Yes --> T[入力値をタグとして追加];
    T --> L;
    S -- No --> U[現在の選択タグで検索実行];
    P -- No --> S;
    A --> V{ユーザーがBackspaceキーを押下};
    V --> W{入力値が空で、選択タグがあるか？};
    W -- Yes --> X[最後のタグを削除];
    L --> Y[検索クエリに選択タグを含める];
    R --> Y;
    T --> Y;
    U --> Y;
    X --> Y;
    Y --> Z[検索結果ページへ遷移];