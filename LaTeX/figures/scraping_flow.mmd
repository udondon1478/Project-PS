%%{init: {'theme': 'base', 'themeVariables': { 'fontSize': '16px'}}}%%
flowchart TB
    subgraph Input["入力"]
        URL["商品URL / 検索条件"]
    end

    subgraph Orchestrator["Orchestrator - 全体制御"]
        Queue["PQueue<br/>(レート制限)"]
        State["処理状態管理<br/>(レジューム対応)"]
    end

    subgraph Crawler["ListingCrawler - 一覧取得"]
        Fetch["HTTPリクエスト"]
        Parse1["HTML解析<br/>(商品URL抽出)"]
        Retry["リトライ処理"]
    end

    subgraph Parser["ProductParser - 商品解析"]
        Parse2["HTML解析<br/>(Cheerio)"]
        Extract["データ抽出<br/>(タイトル・価格・画像等)"]
        Normalize["データ正規化"]
    end

    subgraph Creator["ProductCreator - DB登録"]
        TagResolve["タグ解決<br/>(TagResolver)"]
        SellerUpsert["販売者登録"]
        ProductCreate["商品登録<br/>(トランザクション)"]
    end

    subgraph Output["出力"]
        DB[("PostgreSQL")]
        Discord["Discord通知"]
    end

    URL --> Queue
    Queue --> Fetch
    Fetch --> Parse1
    Parse1 --> Retry
    Retry -->|失敗時| Fetch
    Parse1 -->|商品URL| Queue
    Queue --> Parse2
    Parse2 --> Extract
    Extract --> Normalize
    Normalize --> TagResolve
    TagResolve --> SellerUpsert
    SellerUpsert --> ProductCreate
    ProductCreate --> DB
    ProductCreate -.-> Discord
    State -.->|状態保存| DB

    classDef input fill:#e3f2fd,stroke:#1565c0
    classDef orchestrator fill:#fff3e0,stroke:#ef6c00
    classDef crawler fill:#e8f5e9,stroke:#2e7d32
    classDef parser fill:#fce4ec,stroke:#c2185b
    classDef creator fill:#f3e5f5,stroke:#7b1fa2
    classDef output fill:#e0f2f1,stroke:#00695c

    class URL input
    class Queue,State orchestrator
    class Fetch,Parse1,Retry crawler
    class Parse2,Extract,Normalize parser
    class TagResolve,SellerUpsert,ProductCreate creator
    class DB,Discord output
