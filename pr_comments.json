[{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750754","pull_request_review_id":3733068303,"id":2749750754,"node_id":"PRRC_kwDOOfgI-s6j5d3i","diff_hunk":"@@ -0,0 +1,177 @@\n+'use server';\n+\n+import { prisma } from '@/lib/prisma';\n+import { auth } from '@/auth';\n+import { Prisma } from '@prisma/client';\n+\n+const MAX_FAVORITE_COUNT = 15;\n+\n+/**\n+ * ãŠæ°—ã«å…¥ã‚Šæ¤œç´¢ã‚’ä¿å­˜ã—ã¾ã™\n+ */\n+export async function saveSearchFavorite(name: string, query: Record<string, any>) {\n+  try {\n+    const session = await auth();\n+    if (!session?.user?.id) {\n+      return { success: false, error: 'Unauthorized' };\n+    }\n+\n+    const userId = session.user.id;\n+    const queryJson = query as Prisma.InputJsonValue;\n+\n+    // åå‰ãŒç©ºã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯\n+    if (!name || name.trim() === '') {\n+      return { success: false, error: 'Name is required' };\n+    }\n+\n+    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œ\n+    const result = await prisma.$transaction(async (tx) => {\n+      // åŒã˜åå‰ã®ãŠæ°—ã«å…¥ã‚ŠãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª\n+      const existingFavorite = await tx.searchFavorite.findUnique({\n+        where: {\n+          userId_name: {\n+            userId,\n+            name,\n+          },\n+        },\n+      });\n+\n+      if (existingFavorite) {\n+        // å­˜åœ¨ã™ã‚‹å ´åˆã¯ä¸Šæ›¸ãæ›´æ–° (ä»¶æ•°ãƒã‚§ãƒƒã‚¯ä¸è¦)\n+        return await tx.searchFavorite.update({\n+          where: { id: existingFavorite.id },\n+          data: {\n+            query: queryJson,\n+            updatedAt: new Date(),\n+          },\n+        });\n+      } else {\n+        // æ–°è¦ä½œæˆ: ä»¶æ•°ä¸Šé™ãƒã‚§ãƒƒã‚¯\n+        const count = await tx.searchFavorite.count({\n+          where: { userId },\n+        });\n+\n+        if (count >= MAX_FAVORITE_COUNT) {\n+          throw new Error(`LIMIT_EXCEEDED`);\n+        }\n+\n+        return await tx.searchFavorite.create({\n+          data: {\n+            userId,\n+            name,\n+            query: queryJson,\n+          },\n+        });\n+      }","path":"src/app/actions/search-favorite.ts","commit_id":"4054c4c892d57573ea96d56175b554715f2bf127","original_commit_id":"32a2a074a80698b124b44d5c06dce9322e17c337","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_âš ï¸ Potential issue_ | _ğŸŸ  Major_\n\n<details>\n<summary>ğŸ§© Analysis chain</summary>\n\nğŸŒ Web query:\n\n`Prisma transaction default isolation level PostgreSQL race condition`\n\nğŸ’¡ Result:\n\n- **Prismaâ€™s default transaction isolation on PostgreSQL is whatever the database is configured for**â€”Prisma does **not** override it unless you set `isolationLevel`. ([prisma.io](https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai))  \n- **PostgreSQLâ€™s default isolation level is `READ COMMITTED`**, so Prisma transactions on Postgres are `READ COMMITTED` by default unless you change either the DB setting or Prismaâ€™s `isolationLevel`. ([prisma.io](https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai))  \n- Under **`READ COMMITTED`**, each statement gets its own snapshot; two `SELECT`s in the same transaction can see different committed data if other transactions commit in betweenâ€”this is a common source of race conditions (e.g., â€œcheck-then-insert/updateâ€ patterns). ([postgresql.org](https://www.postgresql.org/docs/9.5/transaction-iso.html?utm_source=openai))  \n- Prisma explicitly notes that **write conflicts can occur at `READ COMMITTED` (Postgres default)** and recommends using a higher isolation level like **`REPEATABLE READ` or `SERIALIZABLE`** to avoid certain concurrency anomalies; with `SERIALIZABLE`, Prisma may throw **P2034** (write conflict/deadlock) and you should retry the transaction. ([prisma.io](https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai))  \n\n**How to set it in Prisma (Postgres):**\n```ts\nawait prisma.$transaction(async (tx) => {\n  // ...\n}, { isolationLevel: Prisma.TransactionIsolationLevel.Serializable })\n```\n(or for batch/sequential `$transaction([...])` with the same option). ([prisma.io](https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai))\n\nCitations:\n\n- 1: https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai\n- 2: https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai\n- 3: https://www.postgresql.org/docs/9.5/transaction-iso.html?utm_source=openai\n- 4: https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai\n- 5: https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai\n\n---\n\nğŸŒ Web query:\n\n`Prisma $executeRaw FOR UPDATE locking user serialization concurrent writes`\n\nğŸ’¡ Result:\n\n`SELECT â€¦ FOR UPDATE` only *locks* rows for as long as the **current transaction** stays open. If you run it via `prisma.$executeRaw(...)` / `prisma.$queryRaw(...)` **without** wrapping it in a Prisma `$transaction`, the statement runs in its own auto-committed transaction, so the lock is released immediately (i.e., it wonâ€™t serialize concurrent writers in the way you expect).\n\n### Pattern that actually serializes concurrent writes (Postgres)\nUse an **interactive transaction**, and run the locking read + write on the **transaction client** (`tx`), not the root client:\n\n```ts\nawait prisma.$transaction(async (tx) => {\n  // lock the row\n  await tx.$queryRaw`\n    SELECT id\n    FROM \"User\"\n    WHERE id = ${userId}\n    FOR UPDATE\n  `\n\n  // now any concurrent tx trying to lock/update the same row will wait (or deadlock/timeout)\n  await tx.user.update({\n    where: { id: userId },\n    data: { /* your write */ },\n  })\n})\n```\n\nPrisma explicitly supports using raw SQL inside `$transaction`, and interactive transactions keep all queries on the same connection (required for row locks to work as intended). [1]\n\n### If youâ€™re seeing â€œserializationâ€ / write-conflict failures\nIf you set the transaction isolation level to `Serializable`, the database may abort one of the concurrent transactions; Prisma exposes this via **P2034** (â€œwrite conflict or deadlockâ€¦ retryâ€). You should catch **P2034** and retry the whole transaction. Prisma documents both `isolationLevel` on `$transaction` and the **P2034** code. [1][2]\n\n```ts\nimport { Prisma } from \"@prisma/client\"\n\nfor (let attempt = 0; attempt < 5; attempt++) {\n  try {\n    return await prisma.$transaction(\n      async (tx) => {\n        await tx.$queryRaw`SELECT id FROM \"User\" WHERE id=${userId} FOR UPDATE`\n        return tx.user.update({ where: { id: userId }, data: {/*...*/} })\n      },\n      { isolationLevel: Prisma.TransactionIsolationLevel.Serializable },\n    )\n  } catch (e: any) {\n    if (e?.code === \"P2034\") continue\n    throw e\n  }\n}\nthrow new Error(\"Too many retries\")\n```\n\n**Rule of thumb:** use `FOR UPDATE` to *block* concurrent writers on the same row; use `Serializable` to make multi-row / predicate-based logic safe, and then be prepared to retry on P2034. [1][2]\n\n**Sources:** Prisma transactions & isolation levels docs [1], Prisma error reference for P2034 [2].\n\n---\n\nğŸŒ Web query:\n\n`PostgreSQL SELECT FOR UPDATE user row lock Prisma concurrent transaction`\n\nğŸ’¡ Result:\n\nIn PostgreSQL, `SELECT â€¦ FOR UPDATE` takes a **row-level lock** on the rows returned, so concurrent transactions that try to `UPDATE/DELETE` (or lock) the same rows will **block until the first transaction ends**. The lock is held until `COMMIT`/`ROLLBACK`. ([postgresql.org](https://www.postgresql.org/docs/9.6/explicit-locking.html?utm_source=openai))\n\n## How to do this correctly with Prisma (PostgreSQL)\n\n### 1) Use an **interactive** `$transaction` and run the locking `SELECT` via `tx.$queryRaw`\nYou **cannot** send `BEGIN; â€¦; COMMIT;` as a single `queryRaw` because Prisma uses prepared statements and Postgres rejects multiple commands in one prepared statement. ([github.com](https://github.com/prisma/prisma/discussions/21335?utm_source=openai))\n\n```ts\nimport { Prisma, PrismaClient } from \"@prisma/client\";\nconst prisma = new PrismaClient();\n\nawait prisma.$transaction(\n  async (tx) => {\n    // lock the row\n    await tx.$queryRaw`\n      SELECT id\n      FROM \"User\"\n      WHERE id = ${userId}\n      FOR UPDATE\n    `;\n\n    // do dependent reads/writes safely while lock is held\n    await tx.user.update({\n      where: { id: userId },\n      data: { balance: { increment: 1 } },\n    });\n  },\n  {\n    // optional but often recommended when correctness matters:\n    isolationLevel: Prisma.TransactionIsolationLevel.Serializable,\n  }\n);\n```\n\nPrisma supports setting `isolationLevel` on transactions (interactive + batch), and Postgresâ€™ default is `ReadCommitted`. ([prisma.io](https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai))\n\n### 2) Prefer a *single-statement* write when possible (often simpler + fewer locks)\nIf your goal is â€œread a row then change itâ€, a single `UPDATE â€¦ WHERE â€¦ RETURNING â€¦` is usually better than â€œSELECT then UPDATEâ€, because Postgres will lock the row as part of the `UPDATE` anyway. (Row locks are acquired by `UPDATE/DELETE`.) ([postgresql.org](https://www.postgresql.org/docs/9.6/explicit-locking.html?utm_source=openai))\n\n### 3) If youâ€™re building a queue/worker pattern, consider `FOR UPDATE SKIP LOCKED`\nThis avoids workers blocking each other by skipping already-locked rows (common for job reservation). (Same locking mechanism as `FOR UPDATE`.) ([postgresql.org](https://www.postgresql.org/docs/9.6/explicit-locking.html?utm_source=openai))\n\n## Notes / gotchas\n- Under Postgres `READ COMMITTED` (the default), each statement sees a new snapshot; `SELECT FOR UPDATE` will lock the *current* version it finds after waiting, which can surprise people doing read-then-write logic. ([postgresql.org](https://www.postgresql.org/docs/9.6/transaction-iso.html?utm_source=openai))\n- `FOR UPDATE` can be **stronger than necessary**; if you donâ€™t need to block inserts referencing a row (FK scenarios) you may want `FOR NO KEY UPDATE`. ([cybertec-postgresql.com](https://www.cybertec-postgresql.com/en/select-for-update-considered-harmful-postgresql/?utm_source=openai))\n\nIf you share your exact concurrency scenario (counter increment, wallet transfer, â€œclaim next jobâ€, etc.), I can suggest the safest minimal-lock query pattern in Prisma.\n\nCitations:\n\n- 1: https://www.postgresql.org/docs/9.6/explicit-locking.html?utm_source=openai\n- 2: https://github.com/prisma/prisma/discussions/21335?utm_source=openai\n- 3: https://www.prisma.io/docs/orm/prisma-client/queries/transactions?utm_source=openai\n- 4: https://www.postgresql.org/docs/9.6/explicit-locking.html?utm_source=openai\n- 5: https://www.postgresql.org/docs/9.6/explicit-locking.html?utm_source=openai\n- 6: https://www.postgresql.org/docs/9.6/transaction-iso.html?utm_source=openai\n- 7: https://www.cybertec-postgresql.com/en/select-for-update-considered-harmful-postgresql/?utm_source=openai\n\n---\n\n\n\n</details>\n\n**ä¸Šé™15ä»¶ãƒã‚§ãƒƒã‚¯ãŒåŒæ™‚ä¿å­˜ã§ç ´ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**\n\nPostgreSQLã®`READ COMMITTED`åˆ†é›¢ãƒ¬ãƒ™ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã§ã¯ã€åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒèµ°ã‚‹ã¨ä¸¡æ–¹ãŒ`count < 15`ã‚’æº€ãŸã—ã¦16ä»¶ä»¥ä¸Šã«ãªã‚‹ç«¶åˆãŒç™ºç”Ÿã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ã§æ›¸ãè¾¼ã¿ã‚’ç›´åˆ—åŒ–ã™ã‚‹ãƒ­ãƒƒã‚¯ã§å¯¾å¿œã—ã¦ãã ã•ã„ã€‚\n\n<details>\n<summary>ğŸ› ï¸ ä¾‹: Userè¡Œã‚’ãƒ­ãƒƒã‚¯ã—ã¦åŒæ™‚ä¿å­˜ã‚’ç›´åˆ—åŒ–</summary>\n\n```diff\n-    const result = await prisma.$transaction(async (tx) => {\n+    const result = await prisma.$transaction(async (tx) => {\n+      // åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒæ™‚ä¿å­˜ã‚’ç›´åˆ—åŒ–\n+      await tx.$executeRaw`SELECT 1 FROM \"User\" WHERE id = ${userId} FOR UPDATE`;\n       // åŒã˜åå‰ã®ãŠæ°—ã«å…¥ã‚ŠãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª\n       const existingFavorite = await tx.searchFavorite.findUnique({\n```\n</details>\n\nã¾ãŸã€ã‚ˆã‚Šæ˜ç¤ºçš„ã«`Serializable`åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®šã—ã€P2034ã‚¨ãƒ©ãƒ¼æ™‚ã«å†è©¦è¡Œã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚\n\n<details>\n<summary>ğŸ¤– Prompt for AI Agents</summary>\n\n```\nIn `@src/app/actions/search-favorite.ts` around lines 27 - 65, The count-based\nlimit can be violated by concurrent transactions; to fix, inside the existing\nprisma.$transaction callback (the async tx => { ... } block in\nsearch-favorite.ts) acquire a row-level lock on the user before\nchecking/creating favorites (e.g., issue a SELECT ... FOR UPDATE against the\nUser row via tx.$executeRaw or read the user with a FOR UPDATE equivalent) so\nconcurrent transactions for the same user are serialized; keep the lock\nacquisition before tx.searchFavorite.count and the upsert/update logic\n(existingFavorite, tx.searchFavorite.update/create), and ensure the transaction\neither throws LIMIT_EXCEEDED or completes while holding the lock; alternatively\nyou may set the transaction isolation to 'Serializable' and implement retry\nlogic on Prisma P2034 errors, but prefer the user-row FOR UPDATE lock to\ndirectly serialize writes per user.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:medusa:eagle -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->","created_at":"2026-01-31T17:09:06Z","updated_at":"2026-01-31T17:09:08Z","html_url":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750754","pull_request_url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288","_links":{"self":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750754"},"html":{"href":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750754"},"pull_request":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288"}},"reactions":{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750754/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":27,"original_start_line":27,"start_side":"RIGHT","line":65,"original_line":65,"side":"RIGHT","author_association":"CONTRIBUTOR","original_position":65,"position":65,"subject_type":"line"},{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750757","pull_request_review_id":3733068303,"id":2749750757,"node_id":"PRRC_kwDOOfgI-s6j5d3l","diff_hunk":"@@ -248,6 +355,11 @@ export default function ProductSearch({\n           searchHistory={history}\n           onHistorySelect={handleHistorySelect}\n           onHistoryDelete={handleHistoryDelete}\n+          // ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½Props\n+          favorites={favorites}\n+          onFavoriteSelect={handleFavoriteSelect}\n+          onFavoriteDelete={handleFavoriteDelete}\n+          onFavoriteRename={(item) => renameFavorite(item.id, item.name)} // åå‰å¤‰æ›´ã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç­‰ãŒå¿…è¦ã ãŒã€ä¸€æ—¦ç°¡æ˜“å®Ÿè£…ã¾ãŸã¯å¾Œå›ã—ã€‚ã“ã“ã§ã¯å‹åˆã‚ã›\n         />","path":"src/components/search/ProductSearch.tsx","commit_id":"4054c4c892d57573ea96d56175b554715f2bf127","original_commit_id":"32a2a074a80698b124b44d5c06dce9322e17c337","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_âš ï¸ Potential issue_ | _ğŸŸ  Major_\n\n**ãŠæ°—ã«å…¥ã‚Šåã®å¤‰æ›´ãŒå®Ÿè³ªç„¡åŠ¹ã§ã™ã€‚**  \nç¾åœ¨ã¯åŒåã§ `renameFavorite` ã‚’å‘¼ã¶ã ã‘ãªã®ã§ã€UIã‹ã‚‰åå‰ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚æœ€ä½é™ã€å…¥åŠ›ã‚’å—ã‘å–ã£ã¦ã‹ã‚‰å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚  \n\n<details>\n<summary>ğŸ› ï¸ ä¾‹: æœ€ä½é™ã®å…¥åŠ›å°ç·šï¼ˆå¾Œã§å°‚ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ç½®ãæ›ãˆå¯ï¼‰</summary>\n\n```diff\n+  const handleFavoriteRename = useCallback((item: SearchFavoriteItem) => {\n+    const newName = window.prompt('æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', item.name);\n+    if (!newName) return;\n+    const trimmed = newName.trim();\n+    if (!trimmed || trimmed === item.name) return;\n+    renameFavorite(item.id, trimmed);\n+  }, [renameFavorite]);\n...\n-          onFavoriteRename={(item) => renameFavorite(item.id, item.name)} // åå‰å¤‰æ›´ã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç­‰ãŒå¿…è¦ã ãŒã€ä¸€æ—¦ç°¡æ˜“å®Ÿè£…ã¾ãŸã¯å¾Œå›ã—ã€‚ã“ã“ã§ã¯å‹åˆã‚ã›\n+          onFavoriteRename={handleFavoriteRename}\n```\n</details>\n\n<details>\n<summary>ğŸ¤– Prompt for AI Agents</summary>\n\n```\nIn `@src/components/search/ProductSearch.tsx` around lines 358 - 363, The current\nonFavoriteRename prop just re-calls renameFavorite with the same item.name, so\nusers cannot change the name; update the onFavoriteRename handler (the inline\narrow currently passing (item) => renameFavorite(item.id, item.name)) to collect\ninput (e.g. via a simple prompt or an inline input flow) and only call\nrenameFavorite(item.id, newName) when the newName is non-empty and different\nfrom item.name; ensure you reference renameFavorite and the onFavoriteRename\nprop so the component receives the new name before invoking the rename\noperation.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:medusa:eagle -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->","created_at":"2026-01-31T17:09:06Z","updated_at":"2026-01-31T17:09:08Z","html_url":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750757","pull_request_url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288","_links":{"self":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750757"},"html":{"href":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750757"},"pull_request":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288"}},"reactions":{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750757/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":355,"original_start_line":358,"start_side":"RIGHT","line":360,"original_line":363,"side":"RIGHT","author_association":"CONTRIBUTOR","original_position":148,"position":240,"subject_type":"line"},{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750759","pull_request_review_id":3733068303,"id":2749750759,"node_id":"PRRC_kwDOOfgI-s6j5d3n","diff_hunk":"@@ -309,10 +421,27 @@ export default function ProductSearch({\n           className=\"hidden md:flex\"\n         />\n \n+        <Button\n+          variant=\"outline\"\n+          size=\"icon\"\n+          onClick={handleOpenSaveModal}\n+          title=\"æ¤œç´¢æ¡ä»¶ã‚’ãŠæ°—ã«å…¥ã‚Šã«ä¿å­˜\"\n+          className=\"flex-shrink-0\"\n+        >\n+          <Star className={`h-4 w-4 ${favorites.some(f => JSON.stringify(f.query) === JSON.stringify({ ...f.query /* å³å¯†ãªæ¯”è¼ƒã¯é›£ã—ã„ãŒã€ç°¡æ˜“çš„ã« */ })) ? \"fill-amber-400 text-amber-400\" : \"text-gray-500\"}`} />\n+        </Button>","path":"src/components/search/ProductSearch.tsx","commit_id":"32a2a074a80698b124b44d5c06dce9322e17c337","original_commit_id":"32a2a074a80698b124b44d5c06dce9322e17c337","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_âš ï¸ Potential issue_ | _ğŸŸ¡ Minor_\n\n**ä¿å­˜çŠ¶æ…‹ã®åˆ¤å®šãŒå¸¸ã« true ã«ãªã‚Šå¾—ã¾ã™ã€‚**  \n`JSON.stringify(f.query) === JSON.stringify({ ...f.query })` ã¯å¸¸ã«ä¸€è‡´ã™ã‚‹ãŸã‚ã€favorites ãŒ1ä»¶ã§ã‚‚ã‚ã‚‹ã¨æ˜ŸãŒå¡—ã‚Šã¤ã¶ã•ã‚Œã¾ã™ã€‚ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã¨æ¯”è¼ƒã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚  \n\n<details>\n<summary>ğŸ› ï¸ ä¾‹: åŒä¸€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§æ¯”è¼ƒ</summary>\n\n```diff\n+  const buildSearchSnapshot = useCallback(() => {\n+    const snapshot: Record<string, any> = {};\n+    if (searchQuery) snapshot.q = searchQuery;\n+    if (selectedTags.length > 0) snapshot.tags = selectedTags;\n+    if (selectedNegativeTags.length > 0) snapshot.ntags = selectedNegativeTags;\n+    if (selectedAgeRatingTags.length > 0) snapshot.age_tags = selectedAgeRatingTags;\n+    if (detailedFilters && Object.keys(detailedFilters).length > 0) {\n+      snapshot.detailedFilters = detailedFilters;\n+      if (detailedFilters.category) snapshot.category = detailedFilters.category;\n+    }\n+    if (priceRange[0] > 0) snapshot.min_price = priceRange[0];\n+    if (shouldSaveMaxPrice(priceRange[1], isHighPriceFilterEnabled)) {\n+      snapshot.max_price = priceRange[1];\n+    }\n+    if (isHighPriceFilterEnabled) snapshot.high_price = true;\n+    if (isLiked) snapshot.liked = true;\n+    if (isOwned) snapshot.owned = true;\n+    if (isSearchPolySeekTagsOnly) snapshot.poly_tags = true;\n+    if (sortBy !== 'newest') snapshot.sort = sortBy;\n+    return snapshot;\n+  }, [\n+    searchQuery, selectedTags, selectedNegativeTags, selectedAgeRatingTags,\n+    detailedFilters, priceRange, isHighPriceFilterEnabled, isLiked, isOwned,\n+    isSearchPolySeekTagsOnly, sortBy\n+  ]);\n...\n-    const historyData: Record<string, any> = {};\n-    if (searchQuery) historyData.q = searchQuery;\n-    if (selectedTags.length > 0) historyData.tags = selectedTags;\n-    if (selectedNegativeTags.length > 0) historyData.ntags = selectedNegativeTags;\n-    if (selectedAgeRatingTags.length > 0) historyData.age_tags = selectedAgeRatingTags;\n-    if (detailedFilters && Object.keys(detailedFilters).length > 0) {\n-      historyData.detailedFilters = detailedFilters;\n-      if (detailedFilters.category) historyData.category = detailedFilters.category;\n-    }\n-    if (priceRange[0] > 0) historyData.min_price = priceRange[0];\n-    if (shouldSaveMaxPrice(priceRange[1], isHighPriceFilterEnabled)) {\n-       historyData.max_price = priceRange[1];\n-    }\n-    if (isHighPriceFilterEnabled) historyData.high_price = true;\n-    if (isLiked) historyData.liked = true;\n-    if (isOwned) historyData.owned = true;\n-    if (isSearchPolySeekTagsOnly) historyData.poly_tags = true;\n-    if (sortBy !== 'newest') historyData.sort = sortBy;\n+    const historyData = buildSearchSnapshot();\n...\n-  }, [\n-    searchQuery, selectedTags, selectedNegativeTags, selectedAgeRatingTags,\n-    detailedFilters, priceRange, isHighPriceFilterEnabled, isLiked, isOwned,\n-    isSearchPolySeekTagsOnly, sortBy, addHistory, originalHandleSearch\n-  ]);\n+  }, [buildSearchSnapshot, addHistory, originalHandleSearch]);\n...\n-    const historyData: Record<string, any> = {};\n-    if (searchQuery) historyData.q = searchQuery;\n-    if (selectedTags.length > 0) historyData.tags = selectedTags;\n-    if (selectedNegativeTags.length > 0) historyData.ntags = selectedNegativeTags;\n-    if (selectedAgeRatingTags.length > 0) historyData.age_tags = selectedAgeRatingTags;\n-    if (detailedFilters && Object.keys(detailedFilters).length > 0) {\n-      historyData.detailedFilters = detailedFilters;\n-      if (detailedFilters.category) historyData.category = detailedFilters.category;\n-    }\n-    if (priceRange[0] > 0) historyData.min_price = priceRange[0];\n-    if (shouldSaveMaxPrice(priceRange[1], isHighPriceFilterEnabled)) {\n-       historyData.max_price = priceRange[1];\n-    }\n-    if (isHighPriceFilterEnabled) historyData.high_price = true;\n-    if (isLiked) historyData.liked = true;\n-    if (isOwned) historyData.owned = true;\n-    if (isSearchPolySeekTagsOnly) historyData.poly_tags = true;\n-    if (sortBy !== 'newest') historyData.sort = sortBy;\n+    const historyData = buildSearchSnapshot();\n     return await addFavorite(name, historyData);\n   };\n+\n+  const currentFavoriteQuery = buildSearchSnapshot();\n+  const currentFavoriteKey = JSON.stringify(currentFavoriteQuery);\n+  const isCurrentFavorite =\n+    Object.keys(currentFavoriteQuery).length > 0 &&\n+    favorites.some(f => JSON.stringify(f.query) === currentFavoriteKey);\n...\n-          <Star className={`h-4 w-4 ${favorites.some(f => JSON.stringify(f.query) === JSON.stringify({ ...f.query /* å³å¯†ãªæ¯”è¼ƒã¯é›£ã—ã„ãŒã€ç°¡æ˜“çš„ã« */ })) ? \"fill-amber-400 text-amber-400\" : \"text-gray-500\"}`} />\n+          <Star className={`h-4 w-4 ${isCurrentFavorite ? \"fill-amber-400 text-amber-400\" : \"text-gray-500\"}`} />\n```\n</details>\n\n<details>\n<summary>ğŸ¤– Prompt for AI Agents</summary>\n\n```\nIn `@src/components/search/ProductSearch.tsx` around lines 424 - 432, The current\nfavorites check always returns true because it compares f.query to a shallow\nclone of itself; change the predicate to compare each favorite's query to the\ncurrent search criteria (e.g., replace JSON.stringify({ ...f.query }) with a\nstable snapshot of the current query state such as JSON.stringify(currentQuery)\nor use a deep equality helper like isEqual(f.query, currentQuery)); update the\nfavorites.some(...) expression inside ProductSearch (where favorites and the\nStar/Button rendering occur) to use that comparison so the star is only filled\nwhen a favorite exactly matches the current search query.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:medusa:eagle -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->\n\nâœ… Addressed in commit 4054c4c","created_at":"2026-01-31T17:09:06Z","updated_at":"2026-01-31T19:38:40Z","html_url":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750759","pull_request_url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288","_links":{"self":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750759"},"html":{"href":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750759"},"pull_request":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288"}},"reactions":{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750759/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":424,"start_side":"RIGHT","line":null,"original_line":432,"side":"RIGHT","author_association":"CONTRIBUTOR","original_position":163,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750760","pull_request_review_id":3733068303,"id":2749750760,"node_id":"PRRC_kwDOOfgI-s6j5d3o","diff_hunk":"@@ -281,56 +336,136 @@ export const TagSearchBar: React.FC<TagSearchBarProps> = ({\n         </div>\n       )}\n \n-      {/* å±¥æ­´è¡¨ç¤º */}\n-      {showHistory && (\n+      {/* å±¥æ­´ãƒ»ãŠæ°—ã«å…¥ã‚Šè¡¨ç¤º */}\n+      {showHistoryOrFavorites && (\n         <div\n           ref={historyListRef}\n           id=\"search-history-list\"\n           role=\"listbox\"\n           tabIndex={-1}\n           className=\"absolute z-20 w-full bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg\"\n         >\n-          <div className=\"px-3 py-1.5 text-xs font-semibold text-gray-500 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700\">\n-            æ¤œç´¢å±¥æ­´\n-          </div>\n-          {searchHistory.map((item, index) => (\n-            <div\n-              key={item.id}\n-              role=\"option\"\n-              aria-selected={index === activeIndex}\n-              tabIndex={index === activeIndex ? 0 : -1}\n-              onKeyDown={(e) => {\n-                if (e.key === 'Enter' || e.key === ' ') {\n-                  e.preventDefault();\n-                  onHistorySelect?.(item);\n-                }\n-              }}\n-              onClick={() => onHistorySelect?.(item)}\n-              onMouseEnter={() => setActiveIndex(index)}\n-              className={`px-3 py-2 text-sm cursor-pointer flex justify-between items-center group ${\n-                index === activeIndex ? 'bg-gray-100 dark:bg-gray-800' : 'hover:bg-gray-100 dark:hover:bg-gray-800'\n-              }`}\n+          {/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ˜ãƒƒãƒ€ãƒ¼ */}\n+          <div className=\"flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 sticky top-0 z-10\">\n+            <button\n+              type=\"button\"\n+              onClick={() => setActiveTab('history')}\n+              className={cn(\n+                \"flex-1 px-3 py-2 text-xs font-semibold text-center transition-colors\",\n+                activeTab === 'history'\n+                  ? \"text-blue-600 border-b-2 border-blue-600 bg-white dark:bg-gray-900\"\n+                  : \"text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700\"\n+              )}\n+            >\n+              <div className=\"flex items-center justify-center gap-1\">\n+                <History size={12} />\n+                <span>å±¥æ­´</span>\n+              </div>\n+            </button>\n+            <button\n+              type=\"button\"\n+              onClick={() => setActiveTab('favorites')}\n+              className={cn(\n+                \"flex-1 px-3 py-2 text-xs font-semibold text-center transition-colors\",\n+                activeTab === 'favorites'\n+                  ? \"text-amber-600 border-b-2 border-amber-600 bg-white dark:bg-gray-900\"\n+                  : \"text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700\"\n+              )}\n             >\n-              <div className=\"flex items-center gap-2 overflow-hidden\">\n-                <Clock size={14} className=\"text-gray-400 flex-shrink-0\" />\n-                <span className=\"truncate text-gray-700 dark:text-gray-300\">\n-                  {formatHistoryQuery(item.query)}\n-                </span>\n+              <div className=\"flex items-center justify-center gap-1\">\n+                <Star size={12} />\n+                <span>ãŠæ°—ã«å…¥ã‚Š</span>\n               </div>\n-              <button\n-                type=\"button\"\n-                onClick={(e) => {\n-                  e.stopPropagation(); // è¦ªã®onClickã‚’ç™ºç«ã•ã›ãªã„\n-                  onHistoryDelete?.(item.id, e);\n+            </button>\n+          </div>","path":"src/components/search/TagSearchBar.tsx","commit_id":"4054c4c892d57573ea96d56175b554715f2bf127","original_commit_id":"32a2a074a80698b124b44d5c06dce9322e17c337","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_âš ï¸ Potential issue_ | _ğŸŸ¡ Minor_\n\n**listboxå†…ã«ã‚¿ãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç½®ãã¨ARIAæ§‹é€ ãŒå´©ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**  \nã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ã§ option ã¨èª¤èªè­˜ã•ã‚Œã‚‹æã‚ŒãŒã‚ã‚‹ãŸã‚ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ `role=\"presentation\"` ã§ç„¡è¦–ã•ã›ã‚‹ã‹ listbox å¤–ã«ç§»å‹•ã—ã¦ãã ã•ã„ã€‚  \n\n<details>\n<summary>ğŸ› ï¸ æœ€å°ä¿®æ­£ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ‰±ã„ï¼‰</summary>\n\n```diff\n-          <div className=\"flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 sticky top-0 z-10\">\n+          <div role=\"presentation\" aria-hidden=\"true\" className=\"flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 sticky top-0 z-10\">\n```\n</details>\n\n<!-- suggestion_start -->\n\n<details>\n<summary>ğŸ“ Committable suggestion</summary>\n\n> â€¼ï¸ **IMPORTANT**\n> Carefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation. Thoroughly test & benchmark the code to ensure it meets the requirements.\n\n```suggestion\n          {/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ˜ãƒƒãƒ€ãƒ¼ */}\n          <div role=\"presentation\" aria-hidden=\"true\" className=\"flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 sticky top-0 z-10\">\n            <button\n              type=\"button\"\n              onClick={() => setActiveTab('history')}\n              className={cn(\n                \"flex-1 px-3 py-2 text-xs font-semibold text-center transition-colors\",\n                activeTab === 'history'\n                  ? \"text-blue-600 border-b-2 border-blue-600 bg-white dark:bg-gray-900\"\n                  : \"text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700\"\n              )}\n            >\n              <div className=\"flex items-center justify-center gap-1\">\n                <History size={12} />\n                <span>å±¥æ­´</span>\n              </div>\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => setActiveTab('favorites')}\n              className={cn(\n                \"flex-1 px-3 py-2 text-xs font-semibold text-center transition-colors\",\n                activeTab === 'favorites'\n                  ? \"text-amber-600 border-b-2 border-amber-600 bg-white dark:bg-gray-900\"\n                  : \"text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700\"\n              )}\n            >\n              <div className=\"flex items-center justify-center gap-1\">\n                <Star size={12} />\n                <span>ãŠæ°—ã«å…¥ã‚Š</span>\n              </div>\n            </button>\n          </div>\n```\n\n</details>\n\n<!-- suggestion_end -->\n\n<details>\n<summary>ğŸ¤– Prompt for AI Agents</summary>\n\n```\nIn `@src/components/search/TagSearchBar.tsx` around lines 348 - 380, The tab\nheader inside TagSearchBar currently sits within the listbox and may be exposed\nas options to screen readers; update the containing div (the element with class\n\"flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800\nsticky top-0 z-10\" that wraps the two buttons using setActiveTab('history') and\nsetActiveTab('favorites')) to be ignored by assistive tech by adding\nrole=\"presentation\" (or move the whole header out of the listbox if you prefer\nstructural change) so the buttons are not misinterpreted as listbox options.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:medusa:eagle -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->","created_at":"2026-01-31T17:09:06Z","updated_at":"2026-01-31T17:09:08Z","html_url":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750760","pull_request_url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288","_links":{"self":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750760"},"html":{"href":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750760"},"pull_request":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288"}},"reactions":{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750760/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":348,"original_start_line":348,"start_side":"RIGHT","line":380,"original_line":380,"side":"RIGHT","author_association":"CONTRIBUTOR","original_position":225,"position":225,"subject_type":"line"},{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750762","pull_request_review_id":3733068303,"id":2749750762,"node_id":"PRRC_kwDOOfgI-s6j5d3q","diff_hunk":"@@ -0,0 +1,162 @@\n+import { useState, useEffect, useCallback } from 'react';\n+import { useSession } from 'next-auth/react';\n+import {\n+  saveSearchFavorite as saveFavoriteApi,\n+  getSearchFavorites as getFavoritesApi,\n+  deleteSearchFavorite as deleteFavoriteApi,\n+  renameSearchFavorite as renameFavoriteApi,\n+} from '@/app/actions/search-favorite';\n+\n+// ãŠæ°—ã«å…¥ã‚Šæ¤œç´¢ã‚¢ã‚¤ãƒ†ãƒ ã®å‹å®šç¾©\n+export interface SearchFavoriteItem {\n+  id: string;\n+  name: string;\n+  query: Record<string, any>;\n+  createdAt: string;\n+}\n+\n+export function useSearchFavorite() {\n+  const { data: session, status } = useSession();\n+  const [favorites, setFavorites] = useState<SearchFavoriteItem[]>([]);\n+  const [isLoading, setIsLoading] = useState(true);\n+\n+  // ãŠæ°—ã«å…¥ã‚Šã®èª­ã¿è¾¼ã¿\n+  useEffect(() => {\n+    const loadFavorites = async () => {\n+      if (status === 'authenticated') {\n+        setIsLoading(true);\n+        try {\n+          const result = await getFavoritesApi();\n+          if (result.success && result.data) {\n+            const formattedFavorites: SearchFavoriteItem[] = result.data.map(item => ({\n+              id: item.id,\n+              name: item.name,\n+              query: item.query as Record<string, any>,\n+              createdAt: typeof item.createdAt === 'string'\n+                ? item.createdAt\n+                : item.createdAt.toISOString(),\n+            }));\n+            setFavorites(formattedFavorites);\n+          }\n+        } catch (error) {\n+          console.error('Failed to load favorites:', error);\n+        } finally {\n+          setIsLoading(false);\n+        }\n+      } else {\n+        setFavorites([]);\n+        setIsLoading(false);\n+      }\n+    };\n+\n+    if (status !== 'loading') {\n+      loadFavorites();\n+    }\n+  }, [status]);\n+\n+  // ãŠæ°—ã«å…¥ã‚Šã®è¿½åŠ \n+  const addFavorite = useCallback(async (name: string, query: Record<string, any>) => {\n+    if (status !== 'authenticated') return { success: false, error: 'Unauthorized' };\n+\n+    try {\n+      const result = await saveFavoriteApi(name, query);\n+      if (result.success && result.data) {\n+        // æˆåŠŸã—ãŸã‚‰ä¸€è¦§ã‚’å†å–å¾—ã™ã‚‹ã‹ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹\n+        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°ï¼ˆã¾ãŸã¯å†å–å¾—ï¼‰\n+        // è¿½åŠ ã®å ´åˆã¯å†å–å¾—ãŒç¢ºå®Ÿã ãŒã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ã«ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°ã‚’æ¤œè¨\n+        // ä¸€æ—¦ãƒªã‚¹ãƒˆã®å…ˆé ­ã«è¿½åŠ ã—ã¦ã‚½ãƒ¼ãƒˆãªã©ã¯ã‚µãƒ¼ãƒãƒ¼ä¾å­˜ã¨ã™ã‚‹ãŸã‚ã€ãƒªãƒ­ãƒ¼ãƒ‰æ¨å¥¨ã ãŒ\n+        // ã“ã“ã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã«è¿½åŠ \n+        const newItem: SearchFavoriteItem = {\n+          id: result.data.id,\n+          name: result.data.name,\n+          query: result.data.query as Record<string, any>,\n+          createdAt: new Date().toISOString(), // ã‚µãƒ¼ãƒãƒ¼ã®æ™‚é–“ã¨å°‘ã—ãšã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Š\n+        };\n+\n+        setFavorites(prev => {\n+          // åŒåãŒã‚ã‚‹å ´åˆã¯æ›´æ–°ï¼ˆidãƒã‚§ãƒƒã‚¯ï¼‰\n+          const existingIndex = prev.findIndex(f => f.id === newItem.id);\n+          if (existingIndex >= 0) {\n+            const newFavorites = [...prev];\n+            newFavorites[existingIndex] = newItem;\n+            return newFavorites;\n+          }\n+          return [newItem, ...prev];\n+        });\n+\n+        return { success: true };\n+      }\n+      return { success: false, error: result.error };\n+    } catch (error) {\n+      console.error('Failed to add favorite:', error);\n+      return { success: false, error: 'Failed to add favorite' };\n+    }\n+  }, [status]);\n+\n+  // ãŠæ°—ã«å…¥ã‚Šã®å‰Šé™¤\n+  const removeFavorite = useCallback(async (id: string) => {\n+    if (status !== 'authenticated') return;\n+\n+    try {\n+      // æ¥½è¦³çš„æ›´æ–°\n+      setFavorites(prev => prev.filter(item => item.id !== id));\n+\n+      const result = await deleteFavoriteApi(id);\n+      if (!result.success) {\n+        // å¤±æ•—ã—ãŸã‚‰æˆ»ã™ãªã©ã®å‡¦ç†ãŒå¿…è¦ã ãŒã€ã“ã“ã§ã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿\n+        console.error('Failed to delete favorite on server');\n+        // å¿…è¦ãªã‚‰ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’å…¥ã‚Œã‚‹\n+      }\n+    } catch (error) {\n+      console.error('Failed to delete favorite:', error);\n+    }\n+  }, [status]);","path":"src/hooks/useSearchFavorite.ts","commit_id":"4054c4c892d57573ea96d56175b554715f2bf127","original_commit_id":"32a2a074a80698b124b44d5c06dce9322e17c337","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_âš ï¸ Potential issue_ | _ğŸŸ¡ Minor_\n\n**å‰Šé™¤ã®æ¥½è¦³æ›´æ–°ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒãªã„ãŸã‚UIä¸æ•´åˆãŒèµ·ãå¾—ã¾ã™ã€‚**  \nã‚µãƒ¼ãƒãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ãŸéš›ã«çŠ¶æ…‹ã‚’æˆ»ã™ã‹å†å–å¾—ã™ã‚‹å‡¦ç†ãŒå¿…è¦ã§ã™ã€‚  \n\n<details>\n<summary>ğŸ› ï¸ å¤±æ•—æ™‚ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ä¾‹</summary>\n\n```diff\n-  const removeFavorite = useCallback(async (id: string) => {\n+  const removeFavorite = useCallback(async (id: string) => {\n     if (status !== 'authenticated') return;\n \n+    const prevFavorites = favorites;\n     try {\n       // æ¥½è¦³çš„æ›´æ–°\n       setFavorites(prev => prev.filter(item => item.id !== id));\n \n       const result = await deleteFavoriteApi(id);\n       if (!result.success) {\n         // å¤±æ•—ã—ãŸã‚‰æˆ»ã™ãªã©ã®å‡¦ç†ãŒå¿…è¦ã ãŒã€ã“ã“ã§ã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿\n         console.error('Failed to delete favorite on server');\n-        // å¿…è¦ãªã‚‰ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’å…¥ã‚Œã‚‹\n+        setFavorites(prevFavorites);\n       }\n     } catch (error) {\n       console.error('Failed to delete favorite:', error);\n+      setFavorites(prevFavorites);\n     }\n-  }, [status]);\n+  }, [status, favorites]);\n```\n</details>\n\n<details>\n<summary>ğŸ¤– Prompt for AI Agents</summary>\n\n```\nIn `@src/hooks/useSearchFavorite.ts` around lines 96 - 113, The removeFavorite\noptimistic update currently mutates state without rollback; capture the previous\nfavorites before calling setFavorites in removeFavorite, then call\ndeleteFavoriteApi(id) and if result.success is false or an exception is thrown\nrestore the saved previous list (or trigger a refetch) so the UI stays\nconsistent; specifically, inside removeFavorite save prevFavorites (from\nsetFavorites callback or a local variable), perform setFavorites(prev =>\nprev.filter(...)), await deleteFavoriteApi(id), and on failure or in catch\nrestore prevFavorites via setFavorites or call the existing fetch function to\nre-sync.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:medusa:eagle -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->","created_at":"2026-01-31T17:09:06Z","updated_at":"2026-01-31T17:09:08Z","html_url":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750762","pull_request_url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288","_links":{"self":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750762"},"html":{"href":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749750762"},"pull_request":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288"}},"reactions":{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749750762/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":96,"original_start_line":96,"start_side":"RIGHT","line":113,"original_line":113,"side":"RIGHT","author_association":"CONTRIBUTOR","original_position":113,"position":113,"subject_type":"line"},{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749924042","pull_request_review_id":3733371138,"id":2749924042,"node_id":"PRRC_kwDOOfgI-s6j6ILK","diff_hunk":"@@ -95,41 +109,65 @@ export default function ProductSearch({\n     return maxPrice !== defaultMax;\n   };\n \n-  // æ¤œç´¢å®Ÿè¡Œæ™‚ã«å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°\n-  const handleSearchWithHistory = useCallback(async () => {\n-    // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰ (URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨äº’æ›æ€§ã®ã‚ã‚‹ã‚­ãƒ¼ã‚’ä½¿ç”¨)\n-    // æ³¨æ„: TagSearchBarã®formatHistoryQueryã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚­ãƒ¼ã¨åˆã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚‹\n-    // formatHistoryQuery: q, tags, ntags, min_price, max_price...\n-    // ã“ã“ã§ã¯åˆ†ã‹ã‚Šã‚„ã™ã•ã®ãŸã‚ã€formatHistoryQueryå´ã‚’ã“ã®æ§‹é€ ã«åˆã‚ã›ã¦ä¿®æ­£ã™ã‚‹æ–¹é‡ã§ã€\n-    // ã¾ãšã¯ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã™ã‚‹\n-    const historyData: Record<string, any> = {};\n-\n-    if (searchQuery) historyData.q = searchQuery;\n-    if (selectedTags.length > 0) historyData.tags = selectedTags;\n-    if (selectedNegativeTags.length > 0) historyData.ntags = selectedNegativeTags;\n-    if (selectedAgeRatingTags.length > 0) historyData.age_tags = selectedAgeRatingTags;\n-\n-    // detailedFilterså…¨ä½“ã‚’ä¿å­˜ (categoryä»¥å¤–ã‚‚å«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚)\n+  // ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹ï¼ˆä¿å­˜ãƒ»æ¯”è¼ƒç”¨ï¼‰\n+  const getCurrentQueryObject = useCallback(() => {\n+    const query: Record<string, any> = {};\n+\n+    if (searchQuery) query.q = searchQuery;\n+    if (selectedTags.length > 0) query.tags = [...selectedTags].sort();\n+    if (selectedNegativeTags.length > 0) query.ntags = [...selectedNegativeTags].sort();\n+    if (selectedAgeRatingTags.length > 0) query.age_tags = [...selectedAgeRatingTags].sort();\n+\n+    // detailedFilters\n     if (detailedFilters && Object.keys(detailedFilters).length > 0) {\n-      historyData.detailedFilters = detailedFilters;\n-      // å¾Œæ–¹äº’æ›æ€§ã‚„formatHistoryQueryã®ãŸã‚ã«categoryã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«ã‚‚å…¥ã‚Œã¦ãŠãï¼ˆé‡è¤‡ã™ã‚‹ãŒå®‰å…¨ï¼‰\n-      if (detailedFilters.category) historyData.category = detailedFilters.category;\n+      const cleanFilters: Record<string, any> = {};\n+      Object.keys(detailedFilters).sort().forEach(key => {\n+        if (detailedFilters[key]) cleanFilters[key] = detailedFilters[key];\n+      });\n+      if (Object.keys(cleanFilters).length > 0) {\n+        query.detailedFilters = cleanFilters;\n+        if (cleanFilters.category) query.category = cleanFilters.category;","path":"src/components/search/ProductSearch.tsx","commit_id":"4054c4c892d57573ea96d56175b554715f2bf127","original_commit_id":"4054c4c892d57573ea96d56175b554715f2bf127","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_âš ï¸ Potential issue_ | _ğŸŸ  Major_\n\n**è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ã® falsy å€¤ãŒä¿å­˜å¯¾è±¡ã‹ã‚‰æ¼ã‚Œã¾ã™ã€‚**  \n`if (detailedFilters[key])` ã ã¨ `false` / `0` ãŒè½ã¡ã€ä¿å­˜ãƒ»å¾©å…ƒã§ãã¾ã›ã‚“ã€‚null/undefined/ç©ºæ–‡å­—ã ã‘é™¤å¤–ã™ã‚‹å½¢ã«ã—ã¦ãã ã•ã„ã€‚  \n\n\n<details>\n<summary>ğŸ› ï¸ ä¿®æ­£æ¡ˆ</summary>\n\n```diff\n-      Object.keys(detailedFilters).sort().forEach(key => {\n-        if (detailedFilters[key]) cleanFilters[key] = detailedFilters[key];\n-      });\n+      Object.keys(detailedFilters).sort().forEach(key => {\n+        const value = detailedFilters[key];\n+        if (value !== undefined && value !== null && value !== '') {\n+          cleanFilters[key] = value;\n+        }\n+      });\n```\n</details>\n\n<!-- suggestion_start -->\n\n<details>\n<summary>ğŸ“ Committable suggestion</summary>\n\n> â€¼ï¸ **IMPORTANT**\n> Carefully review the code before committing. Ensure that it accurately replaces the highlighted code, contains no missing lines, and has no issues with indentation. Thoroughly test & benchmark the code to ensure it meets the requirements.\n\n```suggestion\n      const cleanFilters: Record<string, any> = {};\n      Object.keys(detailedFilters).sort().forEach(key => {\n        const value = detailedFilters[key];\n        if (value !== undefined && value !== null && value !== '') {\n          cleanFilters[key] = value;\n        }\n      });\n      if (Object.keys(cleanFilters).length > 0) {\n        query.detailedFilters = cleanFilters;\n        if (cleanFilters.category) query.category = cleanFilters.category;\n```\n\n</details>\n\n<!-- suggestion_end -->\n\n<details>\n<summary>ğŸ¤– Prompt for AI Agents</summary>\n\n```\nIn `@src/components/search/ProductSearch.tsx` around lines 123 - 129, The current\nloop building cleanFilters drops falsy but valid values (e.g., false, 0) because\nit uses if (detailedFilters[key]); update the filter-preservation logic in\nProductSearch (the detailedFilters -> cleanFilters block) to only exclude null,\nundefined, and empty-string values while keeping 0/false; keep the\nObject.keys(detailedFilters).sort() iteration and ensure after assigning\nquery.detailedFilters = cleanFilters you still copy category with if\n(cleanFilters.category) replaced by a check that treats\nempty-string/null/undefined as excluded so a valid false/0 category is preserved\nas appropriate.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:poseidon:eagle -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->","created_at":"2026-01-31T19:42:47Z","updated_at":"2026-01-31T19:42:48Z","html_url":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749924042","pull_request_url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288","_links":{"self":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749924042"},"html":{"href":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749924042"},"pull_request":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288"}},"reactions":{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749924042/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":123,"original_start_line":123,"start_side":"RIGHT","line":129,"original_line":129,"side":"RIGHT","author_association":"CONTRIBUTOR","original_position":78,"position":78,"subject_type":"line"},{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749924046","pull_request_review_id":3733371138,"id":2749924046,"node_id":"PRRC_kwDOOfgI-s6j6ILO","diff_hunk":"@@ -95,41 +109,65 @@ export default function ProductSearch({\n     return maxPrice !== defaultMax;\n   };\n \n-  // æ¤œç´¢å®Ÿè¡Œæ™‚ã«å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°\n-  const handleSearchWithHistory = useCallback(async () => {\n-    // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰ (URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨äº’æ›æ€§ã®ã‚ã‚‹ã‚­ãƒ¼ã‚’ä½¿ç”¨)\n-    // æ³¨æ„: TagSearchBarã®formatHistoryQueryã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚­ãƒ¼ã¨åˆã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚‹\n-    // formatHistoryQuery: q, tags, ntags, min_price, max_price...\n-    // ã“ã“ã§ã¯åˆ†ã‹ã‚Šã‚„ã™ã•ã®ãŸã‚ã€formatHistoryQueryå´ã‚’ã“ã®æ§‹é€ ã«åˆã‚ã›ã¦ä¿®æ­£ã™ã‚‹æ–¹é‡ã§ã€\n-    // ã¾ãšã¯ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã™ã‚‹\n-    const historyData: Record<string, any> = {};\n-\n-    if (searchQuery) historyData.q = searchQuery;\n-    if (selectedTags.length > 0) historyData.tags = selectedTags;\n-    if (selectedNegativeTags.length > 0) historyData.ntags = selectedNegativeTags;\n-    if (selectedAgeRatingTags.length > 0) historyData.age_tags = selectedAgeRatingTags;\n-\n-    // detailedFilterså…¨ä½“ã‚’ä¿å­˜ (categoryä»¥å¤–ã‚‚å«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚)\n+  // ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹ï¼ˆä¿å­˜ãƒ»æ¯”è¼ƒç”¨ï¼‰\n+  const getCurrentQueryObject = useCallback(() => {\n+    const query: Record<string, any> = {};\n+\n+    if (searchQuery) query.q = searchQuery;\n+    if (selectedTags.length > 0) query.tags = [...selectedTags].sort();\n+    if (selectedNegativeTags.length > 0) query.ntags = [...selectedNegativeTags].sort();\n+    if (selectedAgeRatingTags.length > 0) query.age_tags = [...selectedAgeRatingTags].sort();\n+\n+    // detailedFilters\n     if (detailedFilters && Object.keys(detailedFilters).length > 0) {\n-      historyData.detailedFilters = detailedFilters;\n-      // å¾Œæ–¹äº’æ›æ€§ã‚„formatHistoryQueryã®ãŸã‚ã«categoryã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«ã‚‚å…¥ã‚Œã¦ãŠãï¼ˆé‡è¤‡ã™ã‚‹ãŒå®‰å…¨ï¼‰\n-      if (detailedFilters.category) historyData.category = detailedFilters.category;\n+      const cleanFilters: Record<string, any> = {};\n+      Object.keys(detailedFilters).sort().forEach(key => {\n+        if (detailedFilters[key]) cleanFilters[key] = detailedFilters[key];\n+      });\n+      if (Object.keys(cleanFilters).length > 0) {\n+        query.detailedFilters = cleanFilters;\n+        if (cleanFilters.category) query.category = cleanFilters.category;\n+      }\n     }\n \n     // ä¾¡æ ¼\n-    if (priceRange[0] > 0) historyData.min_price = priceRange[0];\n-\n-    // ä¸Šé™ä¾¡æ ¼ã®ä¿å­˜æ¡ä»¶\n+    if (priceRange[0] > 0) query.min_price = priceRange[0];\n     if (shouldSaveMaxPrice(priceRange[1], isHighPriceFilterEnabled)) {\n-       historyData.max_price = priceRange[1];\n+       query.max_price = priceRange[1];\n     }\n \n-    if (isHighPriceFilterEnabled) historyData.high_price = true;\n+    if (isHighPriceFilterEnabled) query.high_price = true;\n+    if (isLiked) query.liked = true;\n+    if (isOwned) query.owned = true;\n+    if (isSearchPolySeekTagsOnly) query.poly_tags = true;\n+    if (sortBy !== 'newest') query.sort = sortBy;\n \n-    if (isLiked) historyData.liked = true;\n-    if (isOwned) historyData.owned = true;\n-    if (isSearchPolySeekTagsOnly) historyData.poly_tags = true;\n-    if (sortBy !== 'newest') historyData.sort = sortBy;\n+    return query;\n+  }, [\n+    searchQuery, selectedTags, selectedNegativeTags, selectedAgeRatingTags,\n+    detailedFilters, priceRange, isHighPriceFilterEnabled, isLiked, isOwned,\n+    isSearchPolySeekTagsOnly, sortBy\n+  ]);\n+\n+  // ç¾åœ¨ã®æ¡ä»¶ãŒä¿å­˜æ¸ˆã¿ã‹ã©ã†ã‹ã‚’åˆ¤å®š\n+  const isCurrentConditionFavorited = React.useMemo(() => {\n+    const currentQuery = getCurrentQueryObject();\n+    const normalize = (obj: any): string => {\n+      if (obj === null || typeof obj !== 'object') return JSON.stringify(obj);\n+      if (Array.isArray(obj)) return JSON.stringify(obj.sort());\n+      return JSON.stringify(Object.keys(obj).sort().reduce((result: any, key: string) => {\n+        result[key] = obj[key];\n+        return result;\n+      }, {}));\n+    };\n+\n+    const currentJson = normalize(currentQuery);\n+    return favorites.some(f => normalize(f.query) === currentJson);\n+  }, [getCurrentQueryObject, favorites]);","path":"src/components/search/ProductSearch.tsx","commit_id":"4054c4c892d57573ea96d56175b554715f2bf127","original_commit_id":"4054c4c892d57573ea96d56175b554715f2bf127","user":{"login":"coderabbitai[bot]","id":136622811,"node_id":"BOT_kgDOCCSy2w","avatar_url":"https://avatars.githubusercontent.com/in/347564?v=4","gravatar_id":"","url":"https://api.github.com/users/coderabbitai%5Bbot%5D","html_url":"https://github.com/apps/coderabbitai","followers_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/followers","following_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/repos","events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/coderabbitai%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"_ğŸ§¹ Nitpick_ | _ğŸ”µ Trivial_\n\n**normalize ãŒé…åˆ—ã‚’ç ´å£Šçš„ã«ã‚½ãƒ¼ãƒˆã—ã¦ state ã‚’å¤‰ç•°ã•ã›ã¾ã™ã€‚**  \n`obj.sort()` ãŒ favorites å†…é…åˆ—ã‚’ç›´æ¥ä¸¦ã¹æ›¿ãˆã‚‹ãŸã‚ render ä¸­ã®å‰¯ä½œç”¨ã«ãªã‚Šã¾ã™ã€‚ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰ã‚½ãƒ¼ãƒˆã—ã€å†å¸°çš„ã«æ­£è¦åŒ–ã™ã‚‹å½¢ã«ã—ã¦ãã ã•ã„ã€‚  \n\n\n<details>\n<summary>â™»ï¸ æ”¹å–„æ¡ˆï¼ˆéç ´å£Šï¼‹å†å¸°æ­£è¦åŒ–ï¼‰</summary>\n\n```diff\n-    const normalize = (obj: any): string => {\n-      if (obj === null || typeof obj !== 'object') return JSON.stringify(obj);\n-      if (Array.isArray(obj)) return JSON.stringify(obj.sort());\n-      return JSON.stringify(Object.keys(obj).sort().reduce((result: any, key: string) => {\n-        result[key] = obj[key];\n-        return result;\n-      }, {}));\n-    };\n+    const normalize = (value: any): any => {\n+      if (value === null || typeof value !== 'object') return value;\n+      if (Array.isArray(value)) return [...value].sort().map(normalize);\n+      return Object.keys(value).sort().reduce((result: any, key: string) => {\n+        result[key] = normalize(value[key]);\n+        return result;\n+      }, {});\n+    };\n \n-    const currentJson = normalize(currentQuery);\n-    return favorites.some(f => normalize(f.query) === currentJson);\n+    const currentJson = JSON.stringify(normalize(currentQuery));\n+    return favorites.some(f => JSON.stringify(normalize(f.query)) === currentJson);\n```\n</details>\n\n<details>\n<summary>ğŸ¤– Prompt for AI Agents</summary>\n\n```\nIn `@src/components/search/ProductSearch.tsx` around lines 152 - 166, The\nnormalize function used inside isCurrentConditionFavorited mutates arrays by\ncalling obj.sort(), which can change favorites state during render; update\nnormalize (used by isCurrentConditionFavorited/getCurrentQueryObject) to perform\na non-destructive, recursive normalization: when obj is an array, create a\nshallow copy (e.g., [...obj]) before sorting and recursively normalize each\nelement (and for objects, recursively normalize each value while sorting keys)\nso no mutation of favorites occurs and comparison remains stable.\n```\n\n</details>\n\n<!-- fingerprinting:phantom:poseidon:eagle -->\n\n<!-- This is an auto-generated comment by CodeRabbit -->","created_at":"2026-01-31T19:42:47Z","updated_at":"2026-01-31T19:42:48Z","html_url":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749924046","pull_request_url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288","_links":{"self":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749924046"},"html":{"href":"https://github.com/udondon1478/Project-PS/pull/288#discussion_r2749924046"},"pull_request":{"href":"https://api.github.com/repos/udondon1478/Project-PS/pulls/288"}},"reactions":{"url":"https://api.github.com/repos/udondon1478/Project-PS/pulls/comments/2749924046/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":152,"original_start_line":152,"start_side":"RIGHT","line":166,"original_line":166,"side":"RIGHT","author_association":"CONTRIBUTOR","original_position":124,"position":124,"subject_type":"line"}]